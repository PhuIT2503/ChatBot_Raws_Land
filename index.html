<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chatbot PhÃ¡p luáº­t</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">ðŸ’¬ Chatbot PhÃ¡p luáº­t</div>
    <div class="chat-box" id="chat-box"></div>
    <div class="chat-input">
      <input type="text" id="user-input" placeholder="Nháº­p tin nháº¯n..." />
      <button id="send-btn">Gá»­i</button>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    let typingTimer = null; // LÆ°u timer cho viá»‡c Ä‘á»•i chá»¯

    function addMessage(text, sender="user") {
      const msg = document.createElement("div");
      msg.classList.add("message", sender);

      if (sender === "bot") {
        let lines = text.split("\n");
        lines.forEach(line => {
          if (line.trim() !== "") {
            let p = document.createElement("div");
            p.classList.add("bot-line");
            p.innerHTML = line;
            msg.appendChild(p);
          }
        });
      } else {
        msg.innerText = text;
      }

      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showTyping() {
      // Clear timer cÅ© náº¿u cÃ³
      if (typingTimer) clearTimeout(typingTimer);

      // XÃ³a typing cÅ© náº¿u cÃ²n
      removeTyping();

      const typing = document.createElement("div");
      typing.classList.add("message", "bot", "typing");
      typing.innerHTML = `Äang suy nghÄ©...`;
      typing.setAttribute("id", "typing");
      chatBox.appendChild(typing);
      chatBox.scrollTop = chatBox.scrollHeight;

      // Sau 12 giÃ¢y Ä‘á»•i chá»¯
      typingTimer = setTimeout(() => {
        const t = document.getElementById("typing");
        if (t) t.innerHTML = "Äang tá»•ng há»£p thÃ´ng tin...";
      }, 12000);
    }

    function removeTyping() {
      const typing = document.getElementById("typing");
      if (typing) typing.remove();
      if (typingTimer) {
        clearTimeout(typingTimer);
        typingTimer = null;
      }
    }

    async function sendMessageToRasa(message) {
      showTyping();
      try {
        const response = await fetch("http://localhost:5005/webhooks/rest/webhook", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sender: "user", message: message })
        });

        const data = await response.json();
        removeTyping();

        if (data && data.length > 0) {
          data.forEach(item => {
            if (item.text) {
              addMessage(item.text, "bot");
            }
          });
        } else {
          addMessage("KhÃ´ng tÃ¬m tháº¥y cÃ¢u tráº£ lá»i phÃ¹ há»£p.", "bot");
        }
      } catch (error) {
        removeTyping();
        addMessage("âŒ Lá»—i káº¿t ná»‘i server.", "bot");
      }
    }

    sendBtn.addEventListener("click", () => {
      const text = input.value.trim();
      if (text) {
        addMessage(text, "user");
        input.value = "";
        sendMessageToRasa(text);
      }
    });

    input.addEventListener("keypress", e => {
      if (e.key === "Enter") sendBtn.click();
    });
  </script>
</body>
</html>
